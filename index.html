import React, { useState, useMemo, useRef, useEffect } from 'react';
import { Plus, List, Wrench, RefreshCcw, Check, Download, Pencil, Trash2, UploadCloud, History, XCircle, CheckCircle, LayoutDashboard, ArrowLeft, Trello, Archive, MessageSquarePlus, BarChart2, TrendingUp, AlertTriangle, Repeat, DollarSign, MessageSquare, FileMinus, Timer } from 'lucide-react';
// Para os gráficos, você precisaria instalar a Recharts: npm install recharts
// Como não podemos fazer isso aqui, os gráficos serão simulados.
// import { BarChart, Bar, PieChart, Pie, Cell, Tooltip, Legend, ResponsiveContainer } from 'recharts';


// --- Constantes ---
const STATUS = {
  OK: 'OK',
  WARN: 'Atenção!',
  SWAP: 'Trocar Ferramenta (TF)',
};

const THRESHOLD = {
  SWAP: 0.8,
  WARN: 0.7,
};

const ESTIMATED_COST_PER_SWAP = 500; // Custo estimado por cada troca de ferramenta

// --- Dados Iniciais de Teste ---
const initialTools = [
    { id: 1, moldId: 'MOLDE-A', toolId: 'FER-A1', usefulLife: 100000, accumulatedProduction: 85000, lastUpdate: '21/08/2025', status: 'Trocar Ferramenta (TF)', notes: 'Ferramenta de precisão.', warning: true, productionHistory: [{ date: '20/08/2025', pieces: 50000 }, { date: '21/08/2025', pieces: 35000 }], isActive: true },
    { id: 2, moldId: 'MOLDE-A', toolId: 'FER-A2', usefulLife: 150000, accumulatedProduction: 30000, lastUpdate: '22/08/2025', status: 'OK', notes: '', warning: false, productionHistory: [{ date: '22/08/2025', pieces: 30000 }], isActive: true },
    { id: 3, moldId: 'MOLDE-B', toolId: 'FER-B1', usefulLife: 200000, accumulatedProduction: 144000, lastUpdate: '22/08/2025', status: 'Atenção!', notes: 'Verificar desgaste a cada 10k peças.', warning: true, productionHistory: [{ date: '19/07/2025', pieces: 100000 }, { date: '22/07/2025', pieces: 44000 }], isActive: true },
    { id: 4, moldId: 'MOLDE-C', toolId: 'FER-C1', usefulLife: 120000, accumulatedProduction: 12000, lastUpdate: '20/08/2025', status: 'OK', notes: '', warning: false, productionHistory: [{ date: '20/08/2025', pieces: 12000 }], isActive: true },
    { id: 5, moldId: 'MOLDE-D', toolId: 'FER-D1', usefulLife: 120000, accumulatedProduction: 115000, lastUpdate: '21/08/2025', status: 'Atenção!', notes: '', warning: true, productionHistory: [{ date: '21/08/2025', pieces: 115000 }], isActive: true },
    { id: 6, moldId: 'MOLDE-E', toolId: 'FER-E1', usefulLife: 100000, accumulatedProduction: 95000, lastUpdate: '22/08/2025', status: 'Trocar Ferramenta (TF)', notes: 'Urgente!', warning: true, productionHistory: [{ date: '22/07/2025', pieces: 95000 }], isActive: true },
];

const initialSwapHistory = [
    { date: '15/07/2025, 10:30:00', moldId: 'MOLDE-B', toolId: 'FER-B1-OLD', productionBeforeSwap: 200000 },
    { date: '01/08/2025, 14:00:00', moldId: 'MOLDE-A', toolId: 'FER-A1-OLD', productionBeforeSwap: 100000 },
    { date: '10/08/2025, 08:00:00', moldId: 'MOLDE-A', toolId: 'FER-A2-OLD', productionBeforeSwap: 150000 },
    { date: '12/08/2025, 09:00:00', moldId: 'MOLDE-E', toolId: 'FER-E1-OLD', productionBeforeSwap: 100000 },
    { date: '20/08/2025, 11:00:00', moldId: 'MOLDE-B', toolId: 'FER-B1-NEW', productionBeforeSwap: 180000 },
];

const initialMoldComments = {
    'MOLDE-A': {
        '20/08/2025': ['Início de produção com lote novo de matéria-prima.'],
        '21/08/2025': ['Pequeno ajuste de pressão realizado às 14h.', 'Verificar rebarba nas próximas 1000 peças.'],
    },
    'MOLDE-B': {
        '22/07/2025': ['Manutenção preventiva realizada.'],
    }
};

const initialScrapData = {
    '07/2025': { 'MOLDE-B': 1200 },
    '08/2025': { 'MOLDE-A': 550, 'MOLDE-E': 250 },
};


// --- Componente do Dashboard ---
const Dashboard = ({ tools, swapHistory, scrapData, onRegisterScrap }) => {
    const currentMonth = new Date().getMonth() + 1;
    const currentYear = new Date().getFullYear();

    // --- KPIs ---
    const kpis = useMemo(() => {
        const activeTools = tools.filter(t => t.isActive);
        
        const toolsInAlert = activeTools.filter(t => t.status !== STATUS.OK).length;

        const productionThisMonth = tools.reduce((total, tool) => {
            return total + (tool.productionHistory || []).reduce((subtotal, entry) => {
                const [day, month, year] = entry.date.split('/');
                if (parseInt(month, 10) === currentMonth && parseInt(year, 10) === currentYear) {
                    return subtotal + entry.pieces;
                }
                return subtotal;
            }, 0);
        }, 0);

        const swapsThisMonth = swapHistory.filter(swap => {
            const [datePart] = swap.date.split(',');
            const [day, month, year] = datePart.split('/');
            return parseInt(month, 10) === currentMonth && parseInt(year, 10) === currentYear;
        }).length;

        return { toolsInAlert, productionThisMonth, swapsThisMonth };
    }, [tools, swapHistory, currentMonth, currentYear]);

    // --- Dados para Gráficos ---
    const chartData = useMemo(() => {
        const statusCounts = tools.filter(t => t.isActive).reduce((acc, tool) => {
            acc[tool.status] = (acc[tool.status] || 0) + 1;
            return acc;
        }, { [STATUS.OK]: 0, [STATUS.WARN]: 0, [STATUS.SWAP]: 0 });

        const top5Production = Object.entries(tools.reduce((acc, tool) => {
            acc[tool.moldId] = (acc[tool.moldId] || 0) + tool.accumulatedProduction;
            return acc;
        }, {})).sort((a, b) => b[1] - a[1]).slice(0, 5);

        const swapsByMonthAndMold = swapHistory.reduce((acc, swap) => {
            const [datePart] = swap.date.split(',');
            const [day, month, year] = datePart.split('/');
            const monthYear = ${month}/${year};

            if (!acc[monthYear]) acc[monthYear] = {};
            if (!acc[monthYear][swap.moldId]) acc[monthYear][swap.moldId] = [];
            acc[monthYear][swap.moldId].push(swap.toolId);
            return acc;
        }, {});

        const scrapByMold = Object.values(scrapData).reduce((acc, monthlyData) => {
            for (const moldId in monthlyData) {
                acc[moldId] = (acc[moldId] || 0) + monthlyData[moldId];
            }
            return acc;
        }, {});
        const maxScrap = Math.max(...Object.values(scrapByMold), 1);

        return { statusCounts, top5Production, swapsByMonthAndMold, scrapByMold, maxScrap };
    }, [tools, swapHistory, scrapData]);

    return (
        <div className="mt-6">
            <div className="flex justify-end mb-4">
                <button
                    onClick={onRegisterScrap}
                    className="flex items-center gap-2 bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition duration-300"
                >
                    <FileMinus size={18} /> Registar Refugo Mensal
                </button>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200 flex items-start gap-4">
                    <div className="bg-blue-100 text-blue-600 p-3 rounded-lg"><TrendingUp size={24} /></div>
                    <div>
                        <h3 className="text-gray-500 font-semibold">Produção do Mês</h3>
                        <p className="text-3xl font-bold text-gray-800">{kpis.productionThisMonth.toLocaleString('pt-BR')}</p>
                    </div>
                </div>
                <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200 flex items-start gap-4">
                    <div className="bg-yellow-100 text-yellow-600 p-3 rounded-lg"><AlertTriangle size={24} /></div>
                    <div>
                        <h3 className="text-gray-500 font-semibold">Ferramentas em Alerta</h3>
                        <p className="text-3xl font-bold text-gray-800">{kpis.toolsInAlert}</p>
                    </div>
                </div>
                <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200 flex items-start gap-4">
                    <div className="bg-purple-100 text-purple-600 p-3 rounded-lg"><Repeat size={24} /></div>
                    <div>
                        <h3 className="text-gray-500 font-semibold">Trocas no Mês</h3>
                        <p className="text-3xl font-bold text-gray-800">{kpis.swapsThisMonth}</p>
                    </div>
                </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h3 className="text-xl font-bold text-gray-700 mb-4">Saúde do Ferramental</h3>
                    <div className="flex justify-center items-center h-64">
                         <div className="w-48 h-48 rounded-full flex overflow-hidden" style={{ background: conic-gradient(#22c55e 0% ${chartData.statusCounts[STATUS.OK] / tools.length * 100}%, #f59e0b ${chartData.statusCounts[STATUS.OK] / tools.length * 100}% ${(chartData.statusCounts[STATUS.OK] + chartData.statusCounts[STATUS.WARN]) / tools.length * 100}%, #ef4444 ${(chartData.statusCounts[STATUS.OK] + chartData.statusCounts[STATUS.WARN]) / tools.length * 100}% 100%) }}></div>
                    </div>
                     <div className="mt-4 space-y-2">
                        <div className="flex items-center"><span className="w-3 h-3 rounded-full mr-2 bg-green-500"></span>OK: {chartData.statusCounts[STATUS.OK]}</div>
                        <div className="flex items-center"><span className="w-3 h-3 rounded-full mr-2 bg-yellow-500"></span>Atenção: {chartData.statusCounts[STATUS.WARN]}</div>
                        <div className="flex items-center"><span className="w-3 h-3 rounded-full mr-2 bg-red-500"></span>Trocar: {chartData.statusCounts[STATUS.SWAP]}</div>
                    </div>
                </div>
                <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h3 className="text-xl font-bold text-gray-700 mb-4">Top 5 - Maior Produção</h3>
                    <div className="space-y-3 h-80 overflow-y-auto pr-2">
                        {chartData.top5Production.map(([moldId, prod]) => (
                            <div key={moldId}>
                                <div className="flex justify-between text-sm mb-1"><span className="font-medium">{moldId}</span><span>{prod.toLocaleString('pt-BR')}</span></div>
                                <div className="w-full bg-gray-200 rounded-full h-2.5"><div className="bg-blue-600 h-2.5 rounded-full" style={{width: ${(prod / chartData.top5Production[0][1]) * 100}%}}></div></div>
                            </div>
                        ))}
                    </div>
                </div>
                <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h3 className="text-xl font-bold text-gray-700 mb-4">Detalhe de Trocas Mensais</h3>
                     <div className="space-y-3 h-80 overflow-y-auto pr-2">
                        {Object.entries(chartData.swapsByMonthAndMold).map(([monthYear, molds]) => (
                            <div key={monthYear} className="text-sm">
                                <p className="font-bold bg-gray-100 p-1 rounded-md">{monthYear}</p>
                                {Object.entries(molds).map(([moldId, swappedTools]) => (
                                    <div key={moldId} className="mt-1 pl-2">
                                        <p className="font-semibold">{moldId}</p>
                                        <ul className="list-disc pl-5 text-gray-600">
                                            {swappedTools.map((toolId, index) => <li key={index}>{toolId}</li>)}
                                        </ul>
                                    </div>
                                ))}
                            </div>
                        ))}
                    </div>
                </div>
                <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h3 className="text-xl font-bold text-gray-700 mb-4">Refugo Total por Molde</h3>
                    <div className="space-y-3 h-80 overflow-y-auto pr-2">
                        {Object.entries(chartData.scrapByMold).map(([moldId, scrap]) => (
                            <div key={moldId}>
                                <div className="flex justify-between text-sm mb-1"><span className="font-medium">{moldId}</span><span>{scrap.toLocaleString('pt-BR')}</span></div>
                                <div className="w-full bg-gray-200 rounded-full h-2.5"><div className="bg-red-500 h-2.5 rounded-full" style={{width: ${(scrap / chartData.maxScrap) * 100}%}}></div></div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </div>
    );
};


export default function App() {
  const [currentView, setCurrentView] = useState('list');
  const [tools, setTools] = useState([]);
  const [newTool, setNewTool] = useState({ moldId: '', toolId: '', usefulLife: '', notes: '' });
  const [dailyProduction, setDailyProduction] = useState({});
  const [deletingId, setDeletingId] = useState(null);
  const fileInputRef = useRef(null);
  const [isHistoryModalOpen, setIsHistoryModalOpen] = useState(false);
  const [selectedToolHistory, setSelectedToolHistory] = useState([]);
  const [selectedToolId, setSelectedToolId] = useState('');
  const [swapHistory, setSwapHistory] = useState([]);
  const [isSwapHistoryModalOpen, setIsSwapHistoryModalOpen] = useState(false);
  const [message, setMessage] = useState(null);
  const [messageType, setMessageType] = useState('info');
  const [isCommentModalOpen, setIsCommentModalOpen] = useState(false);
  const [currentComment, setCurrentComment] = useState('');
  const [commentingMoldId, setCommentingMoldId] = useState(null);
  const [isMoldCommentsModalOpen, setIsMoldCommentsModalOpen] = useState(false);
  const [selectedMoldComments, setSelectedMoldComments] = useState([]);
  const [viewingCommentsForMold, setViewingCommentsForMold] = useState('');
  const [moldComments, setMoldComments] = useState({});
  const [scrapData, setScrapData] = useState({});
  const [isScrapModalOpen, setIsScrapModalOpen] = useState(false);
  const [scrapEntry, setScrapEntry] = useState({ monthYear: '', moldId: '', quantity: '' });
  
  useEffect(() => {
    try {
        const savedTools = localStorage.getItem('toolData');
        if (savedTools && JSON.parse(savedTools).length > 0) {
            setTools(JSON.parse(savedTools));
        } else {
            setTools(initialTools);
        }

        const savedSwapHistory = localStorage.getItem('swapHistory');
        if (savedSwapHistory) {
            setSwapHistory(JSON.parse(savedSwapHistory));
        } else {
            setSwapHistory(initialSwapHistory);
        }

        const savedMoldComments = localStorage.getItem('moldComments');
        if (savedMoldComments) {
            setMoldComments(JSON.parse(savedMoldComments));
        } else {
            setMoldComments(initialMoldComments);
        }
        
        const savedScrapData = localStorage.getItem('scrapData');
        if (savedScrapData) {
            setScrapData(JSON.parse(savedScrapData));
        } else {
            setScrapData(initialScrapData);
        }
    } catch (error) {
        console.error("Failed to parse data from localStorage, loading initial data.", error);
        setTools(initialTools);
        setSwapHistory(initialSwapHistory);
        setMoldComments(initialMoldComments);
        setScrapData(initialScrapData);
    }
  }, []);

  useEffect(() => {
    if (message) {
      const timer = setTimeout(() => setMessage(null), 3000);
      return () => clearTimeout(timer);
    }
  }, [message]);

  const saveToolsToLocalStorage = (currentTools) => {
    localStorage.setItem('toolData', JSON.stringify(currentTools));
  };
  
  const saveSwapHistoryToLocalStorage = (currentHistory) => {
    localStorage.setItem('swapHistory', JSON.stringify(currentHistory));
  };

  const saveMoldCommentsToLocalStorage = (comments) => {
    localStorage.setItem('moldComments', JSON.stringify(comments));
  };
  
  const saveScrapDataToLocalStorage = (data) => {
    localStorage.setItem('scrapData', JSON.stringify(data));
  };

  const handleNewToolChange = (e) => {
    const { name, value } = e.target;
    setNewTool(prevState => ({ ...prevState, [name]: value }));
  };

  const handleAddTool = (e) => {
    e.preventDefault();
    if (newTool.moldId && newTool.toolId && newTool.usefulLife) {
      const newToolData = {
        id: Date.now(),
        moldId: newTool.moldId,
        toolId: newTool.toolId,
        usefulLife: parseFloat(newTool.usefulLife),
        accumulatedProduction: 0,
        lastUpdate: new Date().toLocaleDateString('pt-BR'),
        status: STATUS.OK,
        notes: newTool.notes,
        warning: false,
        productionHistory: [],
        isActive: true,
      };
      const updatedTools = [...tools, newToolData];
      setTools(updatedTools);
      saveToolsToLocalStorage(updatedTools);
      setNewTool({ moldId: '', toolId: '', usefulLife: '', notes: '' });
      setMessage("Ferramenta adicionada com sucesso!");
      setMessageType('success');
    }
  };

  const handleUpdateMoldProduction = (moldId, value) => {
    const productionValue = parseFloat(value || '0');

    if (isNaN(productionValue) || productionValue <= 0) {
        setMessage("Adicione um valor de produção válido para salvar.");
        setMessageType('error');
        return;
    }

    let toolUpdated = false;
    const updatedTools = tools.map(tool => {
      if (tool.moldId === moldId && tool.isActive && !toolUpdated) {
        toolUpdated = true;
        const newAccumulatedProduction = tool.accumulatedProduction + productionValue;
        const consumedPercentage = newAccumulatedProduction / tool.usefulLife;
        
        let newStatus = STATUS.OK;
        let newWarning = false;
        
        if (consumedPercentage >= THRESHOLD.SWAP) newStatus = STATUS.SWAP;
        else if (consumedPercentage >= THRESHOLD.WARN) newStatus = STATUS.WARN;
        
        if (newStatus !== STATUS.OK) newWarning = true;
        
        const updatedHistory = [...(tool.productionHistory || []), {
          date: new Date().toLocaleDateString('pt-BR'),
          pieces: productionValue,
        }];

        return {
          ...tool,
          accumulatedProduction: newAccumulatedProduction,
          status: newStatus,
          warning: newWarning,
          lastUpdate: new Date().toLocaleDateString('pt-BR'),
          productionHistory: updatedHistory,
        };
      }
      return tool;
    });

    if (!toolUpdated) {
      setMessage(Nenhuma ferramenta ativa encontrada para o molde ${moldId}. Adicione uma nova.);
      setMessageType('error');
      return;
    }

    setTools(updatedTools);
    saveToolsToLocalStorage(updatedTools);
    setDailyProduction(prevState => ({ ...prevState, [moldId]: '' }));
    setMessage("Registo de produção salvo!");
    setMessageType('success');
  };

  const handleSwapTool = (toolId) => {
    const toolToSwap = tools.find(tool => tool.id === toolId);
    if (toolToSwap) {
      const swapRecord = {
        date: new Date().toLocaleString('pt-BR'),
        moldId: toolToSwap.moldId,
        toolId: toolToSwap.toolId,
        productionBeforeSwap: toolToSwap.accumulatedProduction
      };
      
      const updatedSwapHistory = [...swapHistory, swapRecord];
      setSwapHistory(updatedSwapHistory);
      saveSwapHistoryToLocalStorage(updatedSwapHistory);
      
      const updatedTools = tools.map(tool => {
        if (tool.id === toolId) {
          return { 
            ...tool, 
            accumulatedProduction: 0,
            status: STATUS.OK,
            warning: false,
            lastUpdate: new Date().toLocaleDateString('pt-BR'),
            productionHistory: []
          };
        }
        return tool;
      });

      setTools(updatedTools);
      saveToolsToLocalStorage(updatedTools);
      
      setMessage(Ferramenta ${toolToSwap.toolId} trocada e produção zerada.);
      setMessageType('success');
    }
  };

  const handleDeleteTool = (toolId) => { setDeletingId(toolId); };
  const handleConfirmDelete = () => {
    const updatedTools = tools.filter(tool => tool.id !== deletingId);
    setTools(updatedTools);
    saveToolsToLocalStorage(updatedTools);
    setDeletingId(null);
    setMessage("Ferramenta excluída com sucesso.");
    setMessageType('success');
  };
  const handleCancelDelete = () => { setDeletingId(null); };
  
  const handleViewHistory = (tool) => { setSelectedToolHistory(tool.productionHistory || []); setSelectedToolId(tool.toolId); setIsHistoryModalOpen(true); };
  const handleCloseHistoryModal = () => { setIsHistoryModalOpen(false); setSelectedToolHistory([]); setSelectedToolId(''); };
  const handleOpenSwapHistoryModal = () => { setIsSwapHistoryModalOpen(true); };
  const handleCloseSwapHistoryModal = () => { setIsSwapHistoryModalOpen(false); };
  
  const handleOpenCommentModal = (moldId) => {
    setCommentingMoldId(moldId);
    setIsCommentModalOpen(true);
  };

  const handleCloseCommentModal = () => {
    setCommentingMoldId(null);
    setCurrentComment('');
    setIsCommentModalOpen(false);
  };

  const handleSaveMoldComment = () => {
    if (!currentComment.trim()) {
        setMessage("O comentário não pode estar vazio.");
        setMessageType('error');
        return;
    }
    const today = new Date().toLocaleDateString('pt-BR');
    const updatedComments = { ...moldComments };
    if (!updatedComments[commentingMoldId]) {
        updatedComments[commentingMoldId] = {};
    }
    if (!updatedComments[commentingMoldId][today]) {
        updatedComments[commentingMoldId][today] = [];
    }
    updatedComments[commentingMoldId][today].push(currentComment);
    
    setMoldComments(updatedComments);
    saveMoldCommentsToLocalStorage(updatedComments);
    setMessage("Comentário salvo com sucesso!");
    setMessageType('success');
    handleCloseCommentModal();
  };
  
  const handleOpenMoldCommentsModal = (moldId) => {
    const commentsForMold = moldComments[moldId] || {};
    setSelectedMoldComments(Object.entries(commentsForMold));
    setViewingCommentsForMold(moldId);
    setIsMoldCommentsModalOpen(true);
  };

  const handleCloseMoldCommentsModal = () => {
    setIsMoldCommentsModalOpen(false);
    setSelectedMoldComments([]);
    setViewingCommentsForMold('');
  };

  const handleSaveScrap = (e) => {
    e.preventDefault();
    const { monthYear, moldId, quantity } = scrapEntry;
    if (!monthYear || !moldId || !quantity || isNaN(parseFloat(quantity))) {
        setMessage("Preencha todos os campos corretamente.");
        setMessageType('error');
        return;
    }

    const updatedScrapData = { ...scrapData };
    if (!updatedScrapData[monthYear]) {
        updatedScrapData[monthYear] = {};
    }
    updatedScrapData[monthYear][moldId] = parseFloat(quantity);
    
    setScrapData(updatedScrapData);
    saveScrapDataToLocalStorage(updatedScrapData);
    setMessage("Registo de refugo salvo!");
    setMessageType('success');
    setIsScrapModalOpen(false);
    setScrapEntry({ monthYear: '', moldId: '', quantity: '' });
  };

  const groupedTools = useMemo(() => { 
    const groups = tools.reduce((acc, tool) => {
      if (!acc[tool.moldId]) { acc[tool.moldId] = []; }
      acc[tool.moldId].push(tool);
      return acc;
    }, {});
    Object.keys(groups).forEach(moldId => {
        groups[moldId].sort((a, b) => (b.isActive - a.isActive));
    });
    return groups;
  }, [tools]);


  return (
    <div className="bg-gray-50 min-h-screen p-4 sm:p-8 font-sans antialiased text-gray-800">
      <div className="container mx-auto bg-white p-6 sm:p-10 rounded-2xl shadow-xl border border-gray-200">
        <header className="mb-8 text-center">
          <h1 className="text-3xl sm:text-4xl font-extrabold text-blue-800 mb-2">Gestão de Troca de Ferramentas</h1>
          <p className="text-sm sm:text-base text-gray-600">Registre e monitore a vida útil de suas ferramentas de forma preditiva.</p>
        </header>

        {/* Sistema de Abas */}
        <div className="w-full max-w-md mx-auto bg-gray-100 rounded-lg p-1.5 mb-8">
            <nav className="flex space-x-2" aria-label="Tabs">
                <button
                    onClick={() => setCurrentView('list')}
                    className={`flex items-center justify-center w-full gap-2 whitespace-nowrap py-2.5 px-4 font-semibold text-sm rounded-md transition-all ${
                        currentView === 'list'
                        ? 'bg-white text-blue-600 shadow-sm'
                        : 'text-gray-600 hover:bg-gray-200 hover:text-gray-800'
                    }`}
                >
                    <Wrench size={16} /> Ferramentas
                </button>
                <button
                    onClick={() => setCurrentView('dashboard')}
                    className={`flex items-center justify-center w-full gap-2 whitespace-nowrap py-2.5 px-4 font-semibold text-sm rounded-md transition-all ${
                        currentView === 'dashboard'
                        ? 'bg-white text-blue-600 shadow-sm'
                        : 'text-gray-600 hover:bg-gray-200 hover:text-gray-800'
                    }`}
                >
                    <BarChart2 size={16} /> Dashboard
                </button>
            </nav>
        </div>

        {/* Modais */}
        {isScrapModalOpen && (
            <div className="fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex justify-center items-center">
                <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
                    <h3 className="text-xl font-bold mb-4">Registar Refugo Mensal</h3>
                    <form onSubmit={handleSaveScrap} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700">Mês/Ano (MM/YYYY)</label>
                            <input type="text" value={scrapEntry.monthYear} onChange={(e) => setScrapEntry({...scrapEntry, monthYear: e.target.value})} placeholder="Ex: 08/2025" className="w-full p-2 border rounded-lg"/>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700">ID do Molde</label>
                            <select value={scrapEntry.moldId} onChange={(e) => setScrapEntry({...scrapEntry, moldId: e.target.value})} className="w-full p-2 border rounded-lg">
                                <option value="">Selecione um Molde</option>
                                {Object.keys(groupedTools).map(moldId => <option key={moldId} value={moldId}>{moldId}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700">Quantidade Refugada</label>
                            <input type="number" value={scrapEntry.quantity} onChange={(e) => setScrapEntry({...scrapEntry, quantity: e.target.value})} placeholder="Nº de peças" className="w-full p-2 border rounded-lg"/>
                        </div>
                        <div className="flex justify-end gap-3 pt-4">
                            <button type="button" onClick={() => setIsScrapModalOpen(false)} className="bg-gray-300 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                            <button type="submit" className="bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Salvar Refugo</button>
                        </div>
                    </form>
                </div>
            </div>
        )}
        {deletingId && (
          <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex justify-center items-center">
            <div className="relative p-8 bg-white w-full max-w-sm mx-4 rounded-xl shadow-lg border border-gray-200">
              <h3 className="text-xl font-bold mb-4 text-red-700">Confirmar Exclusão</h3>
              <p className="text-gray-700 mb-6">Tem certeza que deseja excluir esta ferramenta? Esta ação não pode ser desfeita.</p>
              <div className="flex justify-end gap-3">
                <button onClick={handleCancelDelete} className="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition duration-300">Cancelar</button>
                <button onClick={handleConfirmDelete} className="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">Excluir</button>
              </div>
            </div>
          </div>
        )}
        {isHistoryModalOpen && (
          <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex justify-center items-center">
            <div className="relative p-8 bg-white w-full max-w-4xl mx-4 rounded-xl shadow-lg border border-gray-200">
              <h3 className="text-xl font-bold mb-4 text-blue-700">Histórico de Produção: {selectedToolId}</h3>
              {selectedToolHistory.length > 0 ? (
                <div className="max-h-96 overflow-y-auto">
                  <table className="w-full text-left table-auto">
                    <thead><tr className="bg-gray-100"><th className="p-3 text-sm font-semibold text-gray-600">Data</th><th className="p-3 text-sm font-semibold text-gray-600">Peças Produzidas</th></tr></thead>
                    <tbody>{selectedToolHistory.map((entry, index) => (<tr key={index} className="border-b"><td className="p-3">{entry.date}</td><td className="p-3">{entry.pieces}</td></tr>))}</tbody>
                  </table>
                </div>
              ) : (<p>Nenhum histórico de produção.</p>)}
              <div className="flex justify-end mt-6"><button onClick={handleCloseHistoryModal} className="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Fechar</button></div>
            </div>
          </div>
        )}
        {isSwapHistoryModalOpen && (
          <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex justify-center items-center">
            <div className="relative p-8 bg-white w-full max-w-2xl mx-4 rounded-xl shadow-lg border border-gray-200">
              <h3 className="text-xl font-bold mb-4 text-purple-700">Histórico de Trocas</h3>
               {swapHistory.length > 0 ? (
                <div className="max-h-96 overflow-y-auto">
                  <table className="w-full text-left table-auto">
                    <thead><tr className="bg-gray-100"><th className="p-3">Data</th><th className="p-3">ID Molde</th><th className="p-3">ID Ferramenta</th><th className="p-3">Produção</th></tr></thead>
                    <tbody>{swapHistory.map((entry, index) => (<tr key={index} className="border-b"><td className="p-3">{entry.date}</td><td className="p-3">{entry.moldId}</td><td className="p-3">{entry.toolId}</td><td className="p-3">{entry.productionBeforeSwap}</td></tr>))}</tbody>
                  </table>
                </div>
              ) : (<p>Nenhum histórico de troca.</p>)}
              <div className="flex justify-end mt-6"><button onClick={handleCloseSwapHistoryModal} className="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700">Fechar</button></div>
            </div>
          </div>
        )}
        {isCommentModalOpen && (
          <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex justify-center items-center">
            <div className="relative p-8 bg-white w-full max-w-lg mx-4 rounded-xl shadow-lg border border-gray-200">
              <h3 className="text-xl font-bold mb-4 text-blue-700">Adicionar Comentário ao Molde</h3>
              <p className="text-gray-600 mb-4">Adicione um comentário para o molde <strong>{commentingMoldId}</strong> na data de hoje.</p>
              <textarea
                value={currentComment}
                onChange={(e) => setCurrentComment(e.target.value)}
                placeholder="Digite seu comentário aqui..."
                className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 min-h-[120px]"
              />
              <div className="flex justify-end gap-3 mt-6">
                <button onClick={handleCloseCommentModal} className="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition duration-300">Cancelar</button>
                <button onClick={handleSaveMoldComment} className="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">Salvar Comentário</button>
              </div>
            </div>
          </div>
        )}
         {isMoldCommentsModalOpen && (
          <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex justify-center items-center">
            <div className="relative p-8 bg-white w-full max-w-4xl mx-4 rounded-xl shadow-lg border border-gray-200">
              <h3 className="text-xl font-bold mb-4 text-blue-700">Comentários do Molde: {viewingCommentsForMold}</h3>
              {selectedMoldComments.length > 0 ? (
                <div className="max-h-96 overflow-y-auto space-y-4">
                  {selectedMoldComments.map(([date, comments], index) => (
                    <div key={index}>
                      <p className="font-semibold bg-gray-100 p-2 rounded-md">{date}</p>
                      <ul className="list-disc pl-8 mt-2 space-y-1">
                        {comments.map((comment, cIndex) => (
                           <li key={cIndex} className="text-gray-700">{comment}</li>
                        ))}
                      </ul>
                    </div>
                  ))}
                </div>
              ) : (<p>Nenhum comentário registrado para este molde.</p>)}
              <div className="flex justify-end mt-6"><button onClick={handleCloseMoldCommentsModal} className="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Fechar</button></div>
            </div>
          </div>
        )}
        
        {message && (
          <div className={fixed top-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full shadow-lg flex items-center gap-3 transition-all duration-300 z-50 ${messageType === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}}>
            {messageType === 'success' ? <CheckCircle size={20} /> : <XCircle size={20} />}
            <span className="font-semibold">{message}</span>
            <button onClick={() => setMessage(null)} className="ml-2"><XCircle size={20} className="text-gray-500 hover:text-gray-700" /></button>
          </div>
        )}

        {currentView === 'list' ? (
            <>
                <section className="bg-blue-50 p-6 rounded-xl border border-blue-200 mb-8">
                    <h2 className="text-xl sm:text-2xl font-bold text-blue-700 mb-4">Adicionar Nova Ferramenta</h2>
                    <form onSubmit={handleAddTool} className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <input type="text" name="moldId" value={newTool.moldId} onChange={handleNewToolChange} placeholder="ID do Molde" required className="w-full p-3 border rounded-lg"/>
                        <input type="text" name="toolId" value={newTool.toolId} onChange={handleNewToolChange} placeholder="ID da Ferramenta" required className="w-full p-3 border rounded-lg"/>
                        <input type="number" name="usefulLife" value={newTool.usefulLife} onChange={handleNewToolChange} placeholder="Vida Útil (peças)" required min="1" className="w-full p-3 border rounded-lg"/>
                        <input type="text" name="notes" value={newTool.notes} onChange={handleNewToolChange} placeholder="Observações" className="w-full p-3 border rounded-lg"/>
                        <button type="submit" className="col-span-1 sm:col-span-2 lg:col-span-4 w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                            <Plus size={20} /> Adicionar
                        </button>
                    </form>
                </section>

                <section>
                  <h2 className="text-xl sm:text-2xl font-bold text-blue-700 mb-4">Ferramentas Ativas</h2>
                  {tools.length === 0 ? (
                    <div className="text-center text-gray-500 p-8 rounded-lg border-2 border-dashed border-gray-300">
                      <List size={48} className="mx-auto mb-4 text-gray-400" />
                      <p>Nenhuma ferramenta registrada.</p>
                    </div>
                  ) : (
                    Object.keys(groupedTools).map(moldId => (
                      <div key={moldId} className="mb-8">
                        <div className="flex items-center justify-between gap-2 text-lg font-semibold bg-gray-100 p-4 rounded-t-lg">
                          <div className="flex items-center gap-2"><Wrench size={24} /> Molde: {moldId}</div>
                           <div className="flex items-center gap-2">
                            <input type="number" value={dailyProduction[moldId] || ''} onChange={(e) => setDailyProduction(prevState => ({ ...prevState, [moldId]: e.target.value }))} placeholder="Prod. Diária" min="0" className="w-32 p-2 border rounded-lg text-sm text-center"/>
                            <button onClick={() => handleOpenCommentModal(moldId)} title="Adicionar Comentário" className="bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600"><MessageSquarePlus size={16} /></button>
                            <button onClick={() => handleOpenMoldCommentsModal(moldId)} title="Ver Comentários do Molde" className="bg-gray-500 text-white p-2 rounded-full hover:bg-gray-600"><MessageSquare size={16} /></button>
                            <button onClick={() => handleUpdateMoldProduction(moldId, dailyProduction[moldId])} title="Salvar Produção" className="bg-green-500 text-white p-2 rounded-full hover:bg-green-600"><Check size={16} /></button>
                          </div>
                        </div>
                        <div className="overflow-x-auto rounded-b-xl shadow-lg">
                          <table className="min-w-full divide-y">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium uppercase">Status</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium uppercase">ID Ferramenta</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium uppercase">Vida Útil</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium uppercase">Produção Acum.</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium uppercase">% Restante</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium uppercase">Condição</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium uppercase">Ações</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y">
                                {groupedTools[moldId].map(tool => (
                                    <tr key={tool.id} className={!tool.isActive ? 'bg-gray-100 text-gray-400' : (tool.status === STATUS.SWAP ? 'bg-red-50' : tool.status === STATUS.WARN ? 'bg-yellow-50' : '')}>
                                        <td className="px-6 py-4">
                                            <span className={px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${tool.isActive ? 'bg-green-100 text-green-800' : 'bg-gray-200 text-gray-700'}}>
                                                {tool.isActive ? 'Ativa' : 'Inativa'}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4">{tool.toolId}</td>
                                        <td className="px-6 py-4">{tool.usefulLife}</td>
                                        <td className="px-6 py-4">{tool.accumulatedProduction}</td>
                                        <td className="px-6 py-4">
                                            <div className="flex items-center">
                                                <div className="w-24 bg-gray-300 rounded-full h-2.5"><div className={h-2.5 rounded-full ${tool.status === STATUS.SWAP ? 'bg-red-500' : tool.status === STATUS.WARN ? 'bg-yellow-500' : 'bg-green-500'}} style={{ width: ${Math.max(0, 100 - (tool.accumulatedProduction / tool.usefulLife) * 100)}% }}></div></div>
                                                <span className="ml-2 text-sm">{Math.max(0, 100 - (tool.accumulatedProduction / tool.usefulLife) * 100).toFixed(2)}%</span>
                                            </div>
                                        </td>
                                        <td className="px-6 py-4">
                                            <div className="flex items-center">
                                                <span className={h-2.5 w-2.5 rounded-full mr-2 ${tool.status === STATUS.SWAP ? 'bg-red-500' : tool.status === STATUS.WARN ? 'bg-yellow-500' : 'bg-green-500'}}></span>
                                                <span className="text-sm text-gray-700">{tool.status}</span>
                                            </div>
                                        </td>
                                        <td className="px-6 py-4">
                                            <div className="flex gap-2">
                                                {tool.isActive && (
                                                    <button onClick={() => handleSwapTool(tool.id)} title="Trocar Ferramenta" className="p-2 text-green-600 hover:bg-green-100 rounded-full"><RefreshCcw size={18} /></button>
                                                )}
                                                <button onClick={() => handleViewHistory(tool)} className="p-2 text-blue-600 hover:bg-blue-100 rounded-full"><History size={18} /></button>
                                                <button onClick={() => handleDeleteTool(tool.id)} className="p-2 text-red-600 hover:bg-red-100 rounded-full"><Trash2 size={18} /></button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    ))
                  )}
                </section>
            </>
        ) : (
            <Dashboard tools={tools} swapHistory={swapHistory} scrapData={scrapData} onRegisterScrap={() => setIsScrapModalOpen(true)} />
        )}
      </div>
    </div>
  );
}